SHELL = /bin/bash

CXX = @CXX@
CXXFLAGS = @CXXFLAGS@ @OPENMP_CXXFLAGS@

FC = @FC@
FCFLAGS = @FCFLAGS@ @OPENMP_FCFLAGS@

CPPFLAGS = @CPPFLAGS@ @CPPFLAGS_ZOLTAN@ -I../include
LDFLAGS = @LDFLAGS@

NVCC = @NVCC@
NVCCFLAGS = @CUDA_CFLAGS@ @NVCCFLAGS@
CUDA_LIBS = @CUDA_LIBS@

LIBS = @LIBS_ZOLTAN@ @LIBS@

LIB = ../lib/libpragmatic.a

ifeq (@USING_FORTRAN@,yes)
TEST_SRC_F90 = $(wildcard src/*.F90)
TEST_BIN_F90 = $(patsubst src/%.F90,bin/%,$(TEST_SRC_F90))
endif
TEST_SRC_CXX = $(wildcard src/*.cpp)
TEST_BIN_CXX = $(patsubst src/%.cpp,bin/%,$(TEST_SRC_CXX))

TEST_SRC = $(TEST_SRC_CXX) $(TEST_SRC_F90)

TEST_BIN = $(TEST_BIN_CXX) $(TEST_BIN_F90)

TEST_SRC_CUDA = $(wildcard src/*.cu)
TEST_BIN_CUDA = $(patsubst src/%.cu,bin/%,$(TEST_SRC_CUDA))

VPATH = ./:./src

.SUFFIXES: .cpp .F90 .o

.cpp.o:
	@$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

.F90.o:
	@$(FC) $(CPPFLAGS) $(FCFLAGS) -c $<

default: test

test: binaries
	@cp src/*.mpi bin/
	python ./unittest bin

ifeq (@ENABLE_CUDA@,yes)
binaries: $(TEST_BIN) $(TEST_BIN_CUDA)
else
binaries: $(TEST_BIN)
endif

bin/%: src/%.cpp ticker.o 
	@echo "    CXX $@"
	@$(CXX) $(LDFLAGS) $(CPPFLAGS) $(CXXFLAGS) -o $@ $< ticker.o $(LIB) $(LIBS)

bin/%: src/%.F90 ticker.o 
	@echo "    FC $@"
	@$(FC) $(LDFLAGS) $(CPPFLAGS) $(FCFLAGS) -o $@ $< ticker.o $(LIB) $(LIBS)

bin/%: src/%.cu
	@echo "    NVCC $@"
	@$(NVCC) $(NVCCFLAGS) -o $@ $< ticker.o $(CUDA_LIBS)

clean:
	rm -rf *.o $(TEST_BIN) bin/test*
