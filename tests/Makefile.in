SHELL = /bin/bash

CXX = @CXX@
CPPFLAGS = @CPPFLAGS@ -I../include
CXXFLAGS = @CXXFLAGS@ @OPENMP_CXXFLAGS@
LDFLAGS = @LDFLAGS@

NVCC = @NVCC@
NVCCFLAGS = @CUDA_CFLAGS@ @NVCCFLAGS@
CUDA_LIBS = @CUDA_LIBS@

LIBS = @LIBS@

LIB = ../lib/libpragmatic.a

TEST_SRC = $(wildcard src/*.cpp)
TEST_BIN = $(patsubst src/%.cpp,bin/%,$(TEST_SRC))

TEST_SRC_CUDA = $(wildcard src/*.cu)
TEST_BIN_CUDA = $(patsubst src/%.cu,bin/%,$(TEST_SRC_CUDA))

VPATH = ./:./src

.SUFFIXES: .cpp .o

.cpp.o:
	@$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

default: test

test: binaries
	@cp src/*.mpi bin/
	python ./unittest bin

ifeq (@ENABLE_CUDA@,yes)
binaries: $(TEST_BIN) $(TEST_BIN_CUDA)
else
binaries: $(TEST_BIN)
endif

bin/%: src/%.cpp ticker.o 
	@echo "    CXX $@"
	@$(CXX) $(LDFLAGS) $(CPPFLAGS) $(CXXFLAGS) -o $@ $< ticker.o $(LIB) $(LIBS)

bin/%: src/%.cu 
	@echo "    NVCC $@"
	@$(NVCC) $(NVCCFLAGS) -o $@ $< ticker.o $(CUDA_LIBS)

clean:
	rm -rf *.o $(TEST_BIN) bin/test*
